

ğŸ§  Media Metadata Agent (LangGraph)

ğŸ¯ é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ª LangGraph é©±åŠ¨çš„æ™ºèƒ½å…ƒæ•°æ® Agentï¼Œ
æ”¯æŒé€šè¿‡ä»£ç†è®¿é—® TMDB / OMDB ç­‰æºï¼Œè‡ªåŠ¨è·å–å½±è§†å…ƒæ•°æ®ã€ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ã€ç”Ÿæˆç¬¦åˆ Infuse / Emby / Jellyfin / Kodi æ ‡å‡†çš„ .nfo æ–‡ä»¶ä¸ç›®å½•ç»“æ„ã€‚

â¸»

ğŸªœ æ ¸å¿ƒåŠŸèƒ½

1 â€“ å®Œæˆ TMDB + LangGraph å…¨é“¾è·¯
	â€¢	è¾“å…¥ TMDB ID æˆ–åç§° â†’ è°ƒç”¨ TMDB API â†’ æ ‡å‡†åŒ– internal_schema
â†’ LLM æ˜ å°„ â†’ ç”Ÿæˆ .nfo â†’ åˆ›å»ºç›®å½•å¹¶ä¸‹è½½å›¾ç‰‡ï¼ˆimages å­ç›®å½•ï¼‰ã€‚

2 â€“ OMDB è¡¥å…¨
	â€¢	ä» OMDB è‡ªåŠ¨è¡¥å…¨æ¼”å‘˜ä¸­è‹±æ–‡åã€è§’è‰²ã€ç®€ä»‹ã€‚
	â€¢	è‹¥æ— ä¸­æ–‡å­—æ®µ â†’ è°ƒç”¨ LLM ç¿»è¯‘ä¸ºä¸­æ–‡å¹¶ç¼“å­˜ã€‚

3 â€“ å…¨é¢å›¾ç‰‡ä¸‹è½½
	â€¢	ä¸‹è½½ tmdb OMDB è·å–çš„poster / fanart / banner / backdrop / logo / stills ç­‰æ‰€æœ‰ç´ æï¼Œ
ç»Ÿä¸€å­˜æ”¾åœ¨ images/ å­æ–‡ä»¶å¤¹ä¸­ã€‚

â¸»

ğŸŒ è¯­è¨€ä¼˜å…ˆä¸ç¿»è¯‘ç­–ç•¥
	1.	ä¼˜å…ˆä¸­æ–‡è¯·æ±‚

curl -x http://127.0.0.1:7897 \
'https://api.themoviedb.org/3/tv/77560?api_key=<KEY>&language=zh-CN'

è¯·æ±‚é¡ºåºï¼š["zh-CN", "zh-TW", "en-US"]

	2.	æ— ä¸­æ–‡æ—¶å›é€€åˆ°ç¿»è¯‘
	â€¢	ä½¿ç”¨ LLM å°† titleã€plotã€taglineã€genresã€actors ç¿»è¯‘ä¸ºä¸­æ–‡
	â€¢	ç¿»è¯‘ç»“æœå†™å…¥ *_zh å­—æ®µ
	3.	æœ€ç»ˆè¾“å‡ºä¸­æ–‡ä¼˜å…ˆ
	â€¢	NFO æ‰€æœ‰æ–‡æœ¬å­—æ®µé»˜è®¤é‡‡ç”¨ä¸­æ–‡ï¼›è‹±æ–‡ä»…ä½œ fallbackã€‚

â¸»

ğŸ“ ç›®å½•ç»“æ„ç¤ºä¾‹ï¼ˆInfuse æ ‡å‡† + images æ–‡ä»¶å¤¹ï¼‰

ç”µå½±

Movies/
â””â”€â”€ åˆæ‹æ—¶é—´ (2023)/
    â”œâ”€â”€ åˆæ‹æ—¶é—´ (2023).nfo
    â”œâ”€â”€ åˆæ‹æ—¶é—´ (2023).mp4
    â””â”€â”€ images/
        â”œâ”€â”€ poster.jpg
        â”œâ”€â”€ fanart.jpg
        â”œâ”€â”€ banner.jpg
        â”œâ”€â”€ backdrop1.jpg
        â”œâ”€â”€ backdrop2.jpg
        â”œâ”€â”€ logo.png
        â””â”€â”€ stills/
            â”œâ”€â”€ 01.jpg
            â”œâ”€â”€ 02.jpg

å‰§é›†

TV/
â””â”€â”€ åˆæ‹æ—¶é—´ (2023)/
    â”œâ”€â”€ tvshow.nfo
    â”œâ”€â”€ images/
    â”‚   â”œâ”€â”€ poster.jpg
    â”‚   â”œâ”€â”€ fanart.jpg
    â”‚   â”œâ”€â”€ banner.jpg
    â”‚   â””â”€â”€ backdrop1.jpg
    â””â”€â”€ Season 01/
        â”œâ”€â”€ åˆæ‹æ—¶é—´.S01E01.å¥³ä»†çš„ç§˜å¯†.mp4
        â”œâ”€â”€ åˆæ‹æ—¶é—´.S01E01.å¥³ä»†çš„ç§˜å¯†.nfo
        â””â”€â”€ images/
            â”œâ”€â”€ S01E01.jpg
            â””â”€â”€ S01E01_banner.jpg


â¸»

ğŸ§© æ•°æ®ç»“æ„å®šä¹‰

internal_schema

class InternalSchema(BaseModel):
    media_type: Literal["movie", "tv"]
    tmdb_id: int
    OMDB_id: Optional[str]
    title: str
    title_zh: Optional[str]
    original_title: Optional[str]
    year: int
    plot: Optional[str]
    plot_zh: Optional[str]
    tagline: Optional[str]
    tagline_zh: Optional[str]
    runtime: Optional[int]
    release_date: Optional[str]
    rating: Optional[float]
    rating_count: Optional[int]
    genres: List[str]
    genres_zh: List[str]
    countries: List[str]
    languages: List[str]
    studios: List[str]
    cast: List[dict]   # [{"name_en": "Cillian Murphy","name_zh": "å¸Œé‡Œå®‰Â·å¢¨è²","role":"Oppenheimer"}]
    directors: List[str]
    writers: List[str]
    images: Dict[str, List[str]]  # {"poster": [...], "banner": [...], "stills": [...]}
    seasons: Optional[List[dict]]
    episodes: Optional[List[dict]]

nfo_schema

MovieNfo

class MovieNfo(BaseModel):
    title: str
    originaltitle: Optional[str]
    year: int
    premiered: Optional[str]
    plot: Optional[str]
    tagline: Optional[str]
    runtime: Optional[int]
    rating: Optional[float]
    votes: Optional[int]
    genre: List[str]
    country: List[str]
    studio: List[str]
    credits: List[str]
    director: List[str]
    actor: List[dict]  # [{"name":"å¸Œé‡Œå®‰Â·å¢¨è²","role":"å¥¥æœ¬æµ·é»˜"}]
    thumb: str
    fanart: str

TvShowNfo / EpisodeNfo ç»“æ„ç›¸åŒï¼Œä»…å­—æ®µç•¥æœ‰å·®å¼‚ã€‚

â¸»

âš™ï¸ LangGraph å·¥ä½œæµ

çŠ¶æ€ç»“æ„

class GraphState(BaseModel):
    input: dict
    search: dict
    source_data: dict
    normalized: dict
    artwork: dict
    nfo: dict
    output: dict
    errors: dict

ä¸»è¦èŠ‚ç‚¹
	1.	ParseInputNode
	2.	SearchNode
	3.	SelectCandidateNode
	4.	FetchNode
	5.	TranslateNode ï¼ˆæ— ä¸­æ–‡æ—¶è°ƒç”¨ LLM ç¿»è¯‘ï¼‰
	6.	OMDBEnrichNode ï¼ˆPhase 3ï¼‰
	7.	NormalizeNode
	8.	PlanArtworkNode
	9.	DownloadAllImagesNode â†’ ä¿å­˜æ‰€æœ‰å›¾ç‰‡åˆ° images/
	10.	LLMMapToNFONode
	11.	ValidateNFONode
	12.	FallbackNFONode
	13.	RenderXMLNode
	14.	WriteOutputNode
	15.	ReportNode

â¸»

ğŸ§  LLM æç¤ºæ¨¡ç‰ˆ

æ˜ å°„æç¤ºè¯

You are a metadata formatter.
Convert the following internal_schema into the specified NFO schema JSON.

- Output strictly valid JSON (no extra text)
- Prefer Chinese text fields when available
- Keep schema field names unchanged
- Use CDATA for plot if needed

ç¿»è¯‘æç¤ºè¯

You are a professional media translator.
Translate the following movie metadata fields into fluent Chinese JSON.
Output strictly valid JSON.


â¸»

ğŸŒ ç½‘ç»œä¸ä»£ç†

proxy:
  http: "http://127.0.0.1:7897"
  https: "http://127.0.0.1:7897"
tmdb:
  base_url: "https://api.themoviedb.org/3"
  api_key: "${TMDB_API_KEY}"
language_priority: ["zh-CN","zh-TW","en-US"]

	â€¢	æ‰€æœ‰è¯·æ±‚å…±ç”¨ä»£ç†ã€‚
	â€¢	è¶…æ—¶ 30sï¼Œé‡è¯• 3 æ¬¡ã€‚
	â€¢	LLM API è¶…æ—¶ 60sã€‚

â¸»

ğŸ§¾ éªŒæ”¶æ ‡å‡†

âœ… è¾“å‡ºç›®å½•ç¬¦åˆ Infuse å‘½åè§„èŒƒï¼›
âœ… å­˜åœ¨ images/ å­ç›®å½•ï¼Œå›¾ç‰‡åŒ…å« poster / banner / fanart / stillsï¼›
âœ… æ‰€æœ‰æ–‡æœ¬å­—æ®µä¸­æ–‡åŒ–å®Œæˆï¼›
âœ… OMDB æˆåŠŸè¡¥å…¨æ¼”å‘˜ä¿¡æ¯ï¼›
âœ… fallback æ¨¡å¼å¯ç‹¬ç«‹è¿è¡Œï¼›
âœ… XML æ ¡éªŒé€šè¿‡ï¼Œæ— ä¹±ç æˆ–éæ³•æ ‡ç­¾ã€‚

â¸»

ğŸ“¦ é¡¹ç›®ç»“æ„

src/
  app/
    cli.py
    graph.py
    state.py
  adapters/
    tmdb.py
    OMDB.py
  core/
    normalize.py
    schema_internal.py
    schema_nfo.py
    llm_mapper.py
    translator.py
    nfo_renderer.py
    artwork.py
    filesystem.py
    cache.py
tests/
  test_graph.py
  test_tmdb_fetch.py
  test_translate.py
config.example.yaml
model_config.example.json
README.md


å¯åŠ¨llmçš„è„šæœ¬ï¼šMedia Metadata Agent/llama_server.sh
é»˜è®¤æ¨¡å‹é…ç½®æ–‡ä»¶ï¼šMedia Metadata Agent/model_config.json

tmdbä»¤ç‰Œä¸å¯†é’¥ï¼š
API è¯»è®¿é—®ä»¤ç‰Œ
eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJkMTdiYzhkOWYxZjFmYTY2MzY4YjU0ZDk1YTI5NjIzNSIsIm5iZiI6MTcxMDY3MTc2MC43NTgwMDAxLCJzdWIiOiI2NWY2Yzc5MGVmOWQ3MjAxNjVkNTJiNTkiLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.1KJI5PDLY-36Z-y_7s4db0seGPrUoNracYMgBnU2po4
API å¯†é’¥
d17bc8d9f1f1fa66368b54d95a296235


OMDb API: http://www.omdbapi.com/?i=tt3896198&apikey=330effac
